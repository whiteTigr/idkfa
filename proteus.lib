VARIABLE HERE
VARIABLE [C]HERE

: ALLOT HERE @ + HERE ! ;
// : [C]ALLOT [C]HERE @ + [C]HERE ! ;
: , HERE @ ! 1 ALLOT ;
// : [C], [C]HERE @ [C]! 1 [C]ALLOT ;
  sdf
: 34NOPS
  NOP NOP NOP NOP NOP NOP NOP NOP NOP NOP
  NOP NOP NOP NOP NOP NOP NOP NOP NOP NOP
  NOP NOP NOP NOP NOP NOP NOP NOP NOP NOP
  NOP NOP NOP NOP
;

: NIP SWAP DROP ; INLINE

: DEPTH         0 SYSREG@ ; INLINE
: RDEPTH        1 SYSREG@ ; INLINE
: I             2 SYSREG@ ; INLINE
: /      34NOPS DROP DROP 3 SYSREG@ ;
: MOD    34NOPS DROP DROP 4 SYSREG@ NIP NIP ;
: /MOD   34NOPS DROP DROP 3 SYSREG@ 4 SYSREG@ ;
: TXSTATE       5 SYSREG@ ; INLINE
: RECEIVED      6 SYSREG@ ; INLINE
: RXCOUNTER     7 SYSREG@ ; INLINE
: SYSTIMER_LOW  8 SYSREG@ ; INLINE
: SYSTIMER_HI   9 SYSREG@ ; INLINE
: USEC         10 SYSREG@ ; INLINE
: MSEC         11 SYSREG@ ; INLINE
: SEC          12 SYSREG@ ; INLINE
: MIN          13 SYSREG@ ; INLINE
: HOUR         14 SYSREG@ ; INLINE

: -1 0 NOT ; INLINE

// *** COM ***
VARIABLE CurrentRXCOUNTER
VARIABLE COMDATA
{ RXCOUNTER CurrentRXCOUNTER ! }

: WAITING_TX
 BEGIN
  TXSTATE NOT IF EXIT THEN
 AGAIN
;

: ->COM
 WAITING_TX
 -1 !
;

: ->COM16
 DUP ->COM
 SHR SHR SHR SHR SHR SHR SHR SHR
 ->COM
;

: ->COM32
 DUP ->COM16
 SHR SHR SHR SHR SHR SHR SHR SHR
 SHR SHR SHR SHR SHR SHR SHR SHR
 ->COM16
;

: CHECKCOM
 RXCOUNTER CurrentRXCOUNTER @ = NOT
; INLINE

: GETCOMDATA
 RXCOUNTER CurrentRXCOUNTER !
 RECEIVED COMDATA !
;

// *** END OF COM ***

: 0< 0x80000000 AND ;
: 0>
 DUP
  0x80000000 AND NOT SWAP
  0x7FFFFFFF AND
 AND
;

: ABS \ ( x -- u )
 DUP 0< IF
  -1 XOR 1 +
 THEN
;

VARIABLE RND

: RANDOMIZE SYSTIMER_LOW RND ! ;
{ RANDOMIZE }

: RANDOM \  ( -- u )
RND @ 69069 * 31415 + 278720333 MOD DUP RND ! ;

: CHOOSE  \ ( u1 -- u2 )
   278720333 SWAP /
   RANDOM ABS SWAP /
;
